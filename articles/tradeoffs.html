<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Design tradeoffs • magrittr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<!--optional theme--><link href="../.css" rel="stylesheet">
<meta property="og:title" content="Design tradeoffs">
<meta property="og:description" content="magrittr">
<meta property="og:image" content="https://magrittr.tidyverse.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">magrittr</a>
        <div class="info hidden-xs hidden-sm">
          <span class="partof">part of the <a href="https://tidyverse.org">tidyverse</a></span>
          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.1.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/magrittr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tradeoffs.html">Design tradeoffs</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Releases</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2020/11/magrittr-2-0-is-here/">Version 2.0.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2014/12/01/magrittr-1-5/">Version 1.5.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
        <li>
  <a href="https://github.com/tidyverse/magrittr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="tradeoffs_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Design tradeoffs</h1>
                        <h4 class="author">Hadley Wickham</h4>
                        <h4 class="author">Lionel Henry</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/magrittr/blob/master/vignettes/tradeoffs.Rmd"><code>vignettes/tradeoffs.Rmd</code></a></small>
      <div class="hidden name"><code>tradeoffs.Rmd</code></div>

    </div>

    
    
<p>There are many different ways that magrittr could implement the pipe. The goal of this document is to elucidate the variations, and the various pros and cons of each approach. This document is primarily aimed at the magrittr developers (so we don’t forget about important considerations), but will be of interest to anyone who wants to understand pipes better, or to create their own pipe that makes different tradeoffs</p>
<div id="code-transformation" class="section level2">
<h2 class="hasAnchor">
<a href="#code-transformation" class="anchor"></a>Code transformation</h2>
<p>There are three main options for how we might transform a pipeline in base R expressions. Here they are illustrated with <code>x %&gt;% foo() %&gt;% bar()</code>:</p>
<ul>
<li>
<p><strong>Nested</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="fu">foo</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p><strong>Eager (mask)</strong>, masking environment</p>
<p>This is essentially how <code><a href="../reference/%&gt;%.html">%&gt;%</a></code> has been implemented prior to magrittr 2.0:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/eval.html">local</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">.</span> <span class="op">&lt;-</span> <span class="va">x</span>
  <span class="va">.</span> <span class="op">&lt;-</span> <span class="fu">foo</span><span class="op">(</span><span class="va">.</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p><strong>Eager (mask-num)</strong>: masking environment, numbered placeholder</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/eval.html">local</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">...1</span> <span class="op">&lt;-</span> <span class="va">x</span>
  <span class="va">...2</span> <span class="op">&lt;-</span> <span class="fu">foo</span><span class="op">(</span><span class="va">...1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="va">...2</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p><strong>Eager (lexical)</strong>: lexical environment</p>
<p>This variant assigns pipe expressions to the placeholder <code>.</code> in the current environment. This assignment is temporary: once the pipe has returned, the placeholder binding is reset to its previous state.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">with_dot_cleanup</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Initialises `.` in the caller environment and resets it on exit.</span>
  <span class="co"># (We use `:=` instead of `=` to avoid partial matching.)</span>
  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/local_bindings.html">local_bindings</a></span><span class="op">(</span><span class="va">.</span> <span class="op">:=</span> <span class="cn">NULL</span>, .env <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="va">expr</span>
<span class="op">}</span>
<span class="fu">with_dot_cleanup</span><span class="op">(</span><span class="op">{</span>
  <span class="va">.</span> <span class="op">&lt;-</span> <span class="va">x</span>
  <span class="va">.</span> <span class="op">&lt;-</span> <span class="fu">foo</span><span class="op">(</span><span class="va">.</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p><strong>Lazy (mask)</strong>: masking environments</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mask1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">env</span><span class="op">)</span>
<span class="va">mask2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">env</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html">delayedAssign</a></span><span class="op">(</span><span class="st">"."</span>, <span class="va">x</span>, <span class="va">mask1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html">delayedAssign</a></span><span class="op">(</span><span class="st">"."</span>, <span class="fu">foo</span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="va">mask2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">mask2</span>, <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p><strong>Lazy (mask-num)</strong>: masking environment, numbered placeholder</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/eval.html">local</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html">delayedAssign</a></span><span class="op">(</span><span class="st">"...1"</span>, <span class="va">x</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html">delayedAssign</a></span><span class="op">(</span><span class="st">"...2"</span>, <span class="fu">foo</span><span class="op">(</span><span class="va">...1</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="va">...2</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
</li>
<li>
<p><strong>Lazy (lexical-num)</strong>: lexical environment, numbered placeholder</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html">delayedAssign</a></span><span class="op">(</span><span class="st">"...1"</span>, <span class="va">x</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html">delayedAssign</a></span><span class="op">(</span><span class="st">"...2"</span>, <span class="fu">foo</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">bar</a></span><span class="op">(</span><span class="va">...2</span><span class="op">)</span></code></pre></div>
</li>
</ul>
<p>We’ll first explore the desired properties we might want a pipe to possess and then see how each of the three variants does.</p>
</div>
<div id="desired-properties" class="section level2">
<h2 class="hasAnchor">
<a href="#desired-properties" class="anchor"></a>Desired properties</h2>
<p>These are the properties that we might want a pipe to possess, roughly ordered from most important to least important.</p>
<ul>
<li><p><strong>Visibility</strong>: the visibility of the final function in the pipe should be preserved. This is important so that pipes that end in a side-effect function (which generally returns its first argument invisibly) do not print.</p></li>
<li><p><strong>Multiple placeholders</strong>: each component of the pipe should only be evaluated once even when there are multiple placeholders, so that <code>sample(10) %&gt;% cbind(., .)</code> yields two columns with the same value. Relatedly, <code>sample(10) %T&gt;% print() %T&gt;% print()</code> must print the same values twice.</p></li>
<li>
<p><strong>Lazy evaluation</strong>: steps of the pipe should only be evaluated when actually needed. This is a useful property as it means that pipes can handle code like <code>stop("!") %&gt;% try()</code>, making pipes capable of capturing a wider range of R expressions.</p>
<p>On the other hand, it might have surprising effects. For instance if a function that suppresses warnings is added to the end of a pipeline, the suppression takes effect for the whole pipeline.</p>
</li>
<li>
<p><strong>Persistence of piped values</strong>: arguments are not necessarily evaluated right away by the piped function. Sometimes they are evaluated long after the pipeline has returned, for example when a function factory is piped. With persistent piped values, the constructed function can be called at any time:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">factory</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span>
<span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="op">%&gt;%</span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] NA</span></code></pre></div>
</li>
<li><p><strong>Refcount neutrality</strong>: the return value of the pipeline should have a reference count of 1 so it can be mutated in place in further manipulations.</p></li>
<li><p><strong>Eager unbinding</strong>: pipes are often used with large data objects, so intermediate objects in the pipeline should be unbound as soon as possible so they are available for garbage collection.</p></li>
<li><p><strong>Progressive stack</strong>: using the pipe should add as few entries to the call stack as possible, so that <code><a href="https://rdrr.io/r/base/traceback.html">traceback()</a></code> is maximally useful.</p></li>
<li><p><strong>Lexical side effects</strong>: side effects should occur in the current lexical environment. This way, <code>NA %&gt;% { foo &lt;- . }</code> assigns the piped value in the current environment and <code>NA %&gt;% { return(.) }</code> returns from the function that contains the pipeline.</p></li>
<li><p><strong>Continuous stack</strong>: the pipe should not affect the chain of parent frames. This is important for tree representations of the call stack.</p></li>
</ul>
<p>It is possible to have proper visibility and a neutral impact on refcounts with all implementations by being a bit careful, so we’ll only consider the other properties:</p>
<table class="table">
<colgroup>
<col width="15%">
<col width="7%">
<col width="11%">
<col width="13%">
<col width="13%">
<col width="10%">
<col width="13%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th></th>
<th align="center">Nested</th>
<th align="center">Eager<br>(mask)</th>
<th align="center">Eager<br>(mask-num)</th>
<th align="center">Eager<br>(lexical)</th>
<th align="center">Lazy<br>(mask)</th>
<th align="center">Lazy<br>(mask-num)</th>
<th align="center">Lazy<br>(lexical-num)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Multiple placeholders</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
</tr>
<tr class="even">
<td>Lazy evaluation</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
</tr>
<tr class="odd">
<td>Persistence</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
</tr>
<tr class="even">
<td>Eager unbinding</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr class="odd">
<td>Progressive stack</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr class="even">
<td>Lexical effects</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
<tr class="odd">
<td>Continuous stack</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
</tbody>
</table>
<div id="implications-of-design-decisions" class="section level3">
<h3 class="hasAnchor">
<a href="#implications-of-design-decisions" class="anchor"></a>Implications of design decisions</h3>
<p>Some properties are a direct reflection of the high level design decisions.</p>
<div id="placeholder-binding" class="section level4">
<h4 class="hasAnchor">
<a href="#placeholder-binding" class="anchor"></a>Placeholder binding</h4>
<p>The nested pipe does not assign piped expressions to a placeholder. All the other variants perform this assignment. This means that with a nested rewrite approach, it isn’t possible to have multiple placeholders unless the piped expression is pasted multiple times. This would cause multiple evaluations with deleterious effects:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span>

<span class="co"># Becomes</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Assigning to the placeholder within an argument would preserve the nestedness and lazyness. However that wouldn’t work properly because there’s no guarantee that the first argument will be evaluated before the second argument.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">foo</span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span>
<span class="fu">foo</span><span class="op">(</span><span class="va">.</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span></code></pre></div>
<p>For these reasons, the nested pipe does not support multiple placeholders. By contrast, all the other variants assign the result of pipe expressions to the placeholder. There are variations in how the placeholder binding is created (lazily or eagerly, in a mask or in the current environment, with numbered symbols or with a unique symbol) but all these variants allow multiple placeholders.</p>
</div>
<div id="masking-environment" class="section level4">
<h4 class="hasAnchor">
<a href="#masking-environment" class="anchor"></a>Masking environment</h4>
<p>Because the local variants of the pipe evaluate in a mask, they do not have lexical effects or a continuous stack. This is unlike the lexical variants that evaluate in the current environment.</p>
</div>
<div id="laziness" class="section level4">
<h4 class="hasAnchor">
<a href="#laziness" class="anchor"></a>Laziness</h4>
<p>Unlike the lazy variants, all eager versions implementing the pipe with iterated evaluation do not pass the lazy evaluation criterion.</p>
<p>Secondly, no lazy variant passes the progressive stack criterion. By construction, lazy evaluation requires pushing all the pipe expressions on the stack before evaluation starts. Conversely, all eager variants have a progressive stack.</p>
</div>
<div id="numbered-placeholders" class="section level4">
<h4 class="hasAnchor">
<a href="#numbered-placeholders" class="anchor"></a>Numbered placeholders</h4>
<p>None of the variants that use numbered placeholders can unbind piped values eagerly. This is how they achieve persistence of these bindings.</p>
</div>
</div>
</div>
<div id="three-implementations" class="section level2">
<h2 class="hasAnchor">
<a href="#three-implementations" class="anchor"></a>Three implementations</h2>
<p>The GNU R team is considering implementing the nested approach in base R with a parse-time code transformation (just like <code><a href="https://rdrr.io/r/base/assignOps.html">-&gt;</a></code> is transformed to <code><a href="https://rdrr.io/r/base/assignOps.html">&lt;-</a></code> by the parser).</p>
<p>We have implemented three approaches in magrittr:</p>
<ul>
<li>The nested pipe</li>
<li>The eager lexical pipe</li>
<li>The lazy masking pipe</li>
</ul>
<p>These approaches have complementary strengths and weaknesses.</p>
<div id="nested-pipe" class="section level3">
<h3 class="hasAnchor">
<a href="#nested-pipe" class="anchor"></a>Nested pipe</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">`%|&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va"><a href="../reference/pipe_eager_lexical.html">pipe_nested</a></span></code></pre></div>
<div id="multiple-placeholders" class="section level4">
<h4 class="hasAnchor">
<a href="#multiple-placeholders" class="anchor"></a>Multiple placeholders ❌</h4>
<p>The nested pipe does not bind expressions to a placeholder and so can’t support multiple placeholders.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="st">"foo"</span> <span class="op">%|&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span>
<span class="co">#&gt; Error: Can't use multiple placeholders.</span></code></pre></div>
</div>
<div id="lazy-evaluation" class="section level4">
<h4 class="hasAnchor">
<a href="#lazy-evaluation" class="anchor"></a>Lazy evaluation ✅</h4>
<p>Because it relies on the usual rules of argument application, the nested pipe is lazy.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"oh no"</span><span class="op">)</span> <span class="op">%|&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span>silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="st">"success"</span>
<span class="op">}</span>
<span class="co">#&gt; [1] "success"</span></code></pre></div>
</div>
<div id="persistence-and-eager-unbinding" class="section level4">
<h4 class="hasAnchor">
<a href="#persistence-and-eager-unbinding" class="anchor"></a>Persistence and eager unbinding ✅</h4>
<p>The pipe expressions are binded as promises within the execution environment of each function. This environment persists as long as a promise holds onto it. Evaluating the promise discards the reference to the environment which becomes available for garbage collection.</p>
<p>For instance, here is a function factory that creates a function. The constructed function returns the value supplied at the time of creation:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">factory</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span>
<span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu">factory</span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>This does not cause any issue with the nested pipe:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op">%|&gt;%</span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="progressive-stack" class="section level4">
<h4 class="hasAnchor">
<a href="#progressive-stack" class="anchor"></a>Progressive stack ❌</h4>
<p>Because the piped expressions are lazily evaluated, the whole pipeline is pushed on the stack before execution starts. This results in a more complex backtrace than necessary:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">faulty</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"tilt"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span>
<span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span>

<span class="fu">faulty</span><span class="op">(</span><span class="op">)</span> <span class="op">%|&gt;%</span> <span class="fu">f</span><span class="op">(</span><span class="op">)</span> <span class="op">%|&gt;%</span> <span class="fu">g</span><span class="op">(</span><span class="op">)</span> <span class="op">%|&gt;%</span> <span class="fu">h</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error in faulty() : tilt</span>

<span class="fu"><a href="https://rdrr.io/r/base/traceback.html">traceback</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; 7: stop("tilt")</span>
<span class="co">#&gt; 6: faulty()</span>
<span class="co">#&gt; 5: f(faulty())</span>
<span class="co">#&gt; 4: g(f(faulty()))</span>
<span class="co">#&gt; 3: h(g(f(faulty())))</span>
<span class="co">#&gt; 2: .External2(magrittr_pipe) at pipe.R#181</span>
<span class="co">#&gt; 1: faulty() %|&gt;% f() %|&gt;% g() %|&gt;% h()</span></code></pre></div>
<p>Also note how the expressions in the backtrace look different from the actual code. This is because of the nested rewrite of the pipeline.</p>
</div>
<div id="lexical-effects" class="section level4">
<h4 class="hasAnchor">
<a href="#lexical-effects" class="anchor"></a>Lexical effects ✅</h4>
<p>This is a benefit of using the normal R rules of evaluation. Side effects occur in the correct environment:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foo</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="cn">TRUE</span> <span class="op">%|&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span><span class="op">(</span><span class="st">"foo"</span>, <span class="va">.</span><span class="op">)</span>
<span class="va">foo</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>Control flow has the correct behaviour:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="cn">TRUE</span> <span class="op">%|&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span>
  <span class="cn">FALSE</span>
<span class="op">}</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
<div id="continuous-stack" class="section level4">
<h4 class="hasAnchor">
<a href="#continuous-stack" class="anchor"></a>Continuous stack ✅</h4>
<p>Because evaluation occurs in the current environment, the stack is continuous. Let’s instrument errors with a structured backtrace to see what that means:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>error <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="va"><a href="https://rlang.r-lib.org/reference/entrace.html">entrace</a></span><span class="op">)</span></code></pre></div>
<p>The tree representation of the backtrace correctly represents the hierarchy of execution frames:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foobar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">%|&gt;%</span> <span class="fu">quux</span><span class="op">(</span><span class="op">)</span>
<span class="va">quux</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">%|&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="op">)</span>

<span class="st">"tilt"</span> <span class="op">%|&gt;%</span> <span class="fu">foobar</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error in x %|&gt;% stop() : tilt</span>

<span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/last_error.html">last_trace</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; &lt;error/rlang_error&gt;</span>
<span class="co">#&gt; tilt</span>
<span class="co">#&gt; Backtrace:</span>
<span class="co">#&gt;     █</span>
<span class="co">#&gt;  1. ├─"tilt" %|&gt;% foobar()</span>
<span class="co">#&gt;  2. └─global::foobar("tilt")</span>
<span class="co">#&gt;  3.   ├─x %|&gt;% quux()</span>
<span class="co">#&gt;  4.   └─global::quux(x)</span>
<span class="co">#&gt;  5.     └─x %|&gt;% stop()</span></code></pre></div>
</div>
</div>
<div id="eager-lexical-pipe" class="section level3">
<h3 class="hasAnchor">
<a href="#eager-lexical-pipe" class="anchor"></a>Eager lexical pipe</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">`%!&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va"><a href="../reference/pipe_eager_lexical.html">pipe_eager_lexical</a></span></code></pre></div>
<div id="multiple-placeholders-1" class="section level4">
<h4 class="hasAnchor">
<a href="#multiple-placeholders-1" class="anchor"></a>Multiple placeholders ✅</h4>
<p>Pipe expressions are eagerly assigned to the placeholder. This makes it possible to use the placeholder multiple times without causing multiple evaluations.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="st">"foo"</span> <span class="op">%!&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] "foo"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] "foo"</span></code></pre></div>
</div>
<div id="lazy-evaluation-1" class="section level4">
<h4 class="hasAnchor">
<a href="#lazy-evaluation-1" class="anchor"></a>Lazy evaluation ❌</h4>
<p>Assignment forces eager evaluation of each step.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"oh no"</span><span class="op">)</span> <span class="op">%!&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span>silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="st">"success"</span>
<span class="op">}</span>
<span class="co">#&gt; Error in stop("oh no") %!&gt;% try(silent = TRUE): oh no</span></code></pre></div>
</div>
<div id="persistence" class="section level4">
<h4 class="hasAnchor">
<a href="#persistence" class="anchor"></a>Persistence: ❌</h4>
<p>Because we’re updating the value of <code>.</code> at each step, the piped expressions are not persistent. This has subtle effects when the piped expressions are not evaluated right away.</p>
<p>With the eager pipe we get rather confusing results with the factory function if we try to call the constructed function in the middle of the pipeline. In the following snippet the placeholder <code>.</code> is binded to the constructed function itself rather than the initial value <code>TRUE</code>, by the time the function is called:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op">%!&gt;%</span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span> <span class="op">%!&gt;%</span> <span class="op">{</span> <span class="fu">.</span><span class="op">(</span><span class="op">)</span> <span class="op">}</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; function() x</span>
<span class="co">#&gt; &lt;bytecode: 0x7f8b7be02810&gt;</span>
<span class="co">#&gt; &lt;environment: 0x7f8b7d971950&gt;</span></code></pre></div>
<p>Also, since we’re binding <code>.</code> in the current environment, we need to clean it up once the pipeline has returned. At that point, the placeholder no longer exists:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op">%!&gt;%</span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error in fn(): object '.' not found</span></code></pre></div>
<p>Or it has been reset to its previous value, if any:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.</span> <span class="op">&lt;-</span> <span class="st">"wrong"</span>
<span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op">%!&gt;%</span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "wrong"</span></code></pre></div>
</div>
<div id="eager-unbinding" class="section level4">
<h4 class="hasAnchor">
<a href="#eager-unbinding" class="anchor"></a>Eager unbinding: ✅</h4>
<p>This is the flip side of updating the value of the placeholder at each step. The previous intermediary values can be collected right away.</p>
</div>
<div id="progressive-stack-1" class="section level4">
<h4 class="hasAnchor">
<a href="#progressive-stack-1" class="anchor"></a>Progressive stack: ✅</h4>
<p>Since pipe expressions are evaluated one by one as they come, only the relevant part of the pipeline is on the stack when an error is thrown:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">faulty</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"tilt"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span>
<span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span>

<span class="fu">faulty</span><span class="op">(</span><span class="op">)</span> <span class="op">%!&gt;%</span> <span class="fu">f</span><span class="op">(</span><span class="op">)</span> <span class="op">%!&gt;%</span> <span class="fu">g</span><span class="op">(</span><span class="op">)</span> <span class="op">%!&gt;%</span> <span class="fu">h</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error in faulty() : tilt</span>

<span class="fu"><a href="https://rdrr.io/r/base/traceback.html">traceback</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; 4: stop("tilt")</span>
<span class="co">#&gt; 3: faulty()</span>
<span class="co">#&gt; 2: .External2(magrittr_pipe) at pipe.R#163</span>
<span class="co">#&gt; 1: faulty() %!&gt;% f() %!&gt;% g() %!&gt;% h()</span></code></pre></div>
</div>
<div id="lexical-effects-and-continuous-stack" class="section level4">
<h4 class="hasAnchor">
<a href="#lexical-effects-and-continuous-stack" class="anchor"></a>Lexical effects and continuous stack: ✅</h4>
<p>Evaluating in the current environment rather than in a mask produces the correct side effects:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foo</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="cn">NA</span> <span class="op">%!&gt;%</span> <span class="op">{</span> <span class="va">foo</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>; <span class="va">.</span> <span class="op">}</span>
<span class="co">#&gt; [1] NA</span>

<span class="va">foo</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="cn">TRUE</span> <span class="op">%!&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span>

  <span class="cn">FALSE</span>
<span class="op">}</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
</div>
<div id="lazy-masking-pipe" class="section level3">
<h3 class="hasAnchor">
<a href="#lazy-masking-pipe" class="anchor"></a>Lazy masking pipe</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">`%?&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va"><a href="../reference/pipe_eager_lexical.html">pipe_lazy_masking</a></span></code></pre></div>
<div id="multiple-placeholders-2" class="section level4">
<h4 class="hasAnchor">
<a href="#multiple-placeholders-2" class="anchor"></a>Multiple placeholders ✅</h4>
<p>Pipe expressions are lazily assigned to the placeholder. This makes it possible to use the placeholder multiple times without causing multiple evaluations.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="st">"foo"</span> <span class="op">%?&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span>
<span class="co">#&gt; [[1]]</span>
<span class="co">#&gt; [1] "foo"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [[2]]</span>
<span class="co">#&gt; [1] "foo"</span></code></pre></div>
</div>
<div id="lazy-evaluation-2" class="section level4">
<h4 class="hasAnchor">
<a href="#lazy-evaluation-2" class="anchor"></a>Lazy evaluation ✅</h4>
<p>Arguments are assigned with <code><a href="https://rdrr.io/r/base/delayedAssign.html">delayedAssign()</a></code> and lazily evaluated:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"oh no"</span><span class="op">)</span> <span class="op">%?&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span>silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="st">"success"</span>
<span class="op">}</span>
<span class="co">#&gt; [1] "success"</span></code></pre></div>
</div>
<div id="persistence-1" class="section level4">
<h4 class="hasAnchor">
<a href="#persistence-1" class="anchor"></a>Persistence: ✅</h4>
<p>The lazy masking pipe uses one masking environment per pipe expression. This allows persistence of the intermediary values and out of order evaluation. The factory function works as expected for instance:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op">%?&gt;%</span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
<div id="eager-unbinding-1" class="section level4">
<h4 class="hasAnchor">
<a href="#eager-unbinding-1" class="anchor"></a>Eager unbinding: ✅</h4>
<p>Because we use one mask environment per pipe expression, the intermediary values can be collected as soon as they are no longer needed.</p>
</div>
<div id="progressive-stack-2" class="section level4">
<h4 class="hasAnchor">
<a href="#progressive-stack-2" class="anchor"></a>Progressive stack: ❌</h4>
<p>With a lazy pipe the whole pipeline is pushed onto the stack before evaluation.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">faulty</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"tilt"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span>
<span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span>
<span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span>

<span class="fu">faulty</span><span class="op">(</span><span class="op">)</span> <span class="op">%?&gt;%</span> <span class="fu">f</span><span class="op">(</span><span class="op">)</span> <span class="op">%?&gt;%</span> <span class="fu">g</span><span class="op">(</span><span class="op">)</span> <span class="op">%?&gt;%</span> <span class="fu">h</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error in faulty() : tilt</span>

<span class="fu"><a href="https://rdrr.io/r/base/traceback.html">traceback</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; 7: stop("tilt")</span>
<span class="co">#&gt; 6: faulty()</span>
<span class="co">#&gt; 5: f(.)</span>
<span class="co">#&gt; 4: g(.)</span>
<span class="co">#&gt; 3: h(.)</span>
<span class="co">#&gt; 2: .External2(magrittr_pipe) at pipe.R#174</span>
<span class="co">#&gt; 1: faulty() %?&gt;% f() %?&gt;% g() %?&gt;% h()</span></code></pre></div>
<p>Note however how the backtrace is less cluttered than with the nested pipe approach, thanks to the placeholder.</p>
</div>
<div id="lexical-effects-1" class="section level4">
<h4 class="hasAnchor">
<a href="#lexical-effects-1" class="anchor"></a>Lexical effects ❌</h4>
<p>The lazy pipe evaluates in a mask. This causes lexical side effects to occur in the incorrect environment.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foo</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="cn">TRUE</span> <span class="op">%?&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span><span class="op">(</span><span class="st">"foo"</span>, <span class="va">.</span><span class="op">)</span>
<span class="va">foo</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<p>Stack-sensitive functions like <code><a href="https://rdrr.io/r/base/function.html">return()</a></code> function cannot find the proper frame environment:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="cn">TRUE</span> <span class="op">%?&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="op">)</span>
  <span class="cn">FALSE</span>
<span class="op">}</span>
<span class="fu">fn</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
</div>
<div id="continuous-stack-1" class="section level4">
<h4 class="hasAnchor">
<a href="#continuous-stack-1" class="anchor"></a>Continuous stack ❌</h4>
<p>The masking environment causes a discontinuous stack tree:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foobar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">%?&gt;%</span> <span class="fu">quux</span><span class="op">(</span><span class="op">)</span>
<span class="va">quux</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">%?&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="op">)</span>

<span class="st">"tilt"</span> <span class="op">%?&gt;%</span> <span class="fu">foobar</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error in x %?&gt;% stop() : tilt</span>

<span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/last_error.html">last_trace</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; &lt;error/rlang_error&gt;</span>
<span class="co">#&gt; tilt</span>
<span class="co">#&gt; Backtrace:</span>
<span class="co">#&gt;     █</span>
<span class="co">#&gt;  1. ├─"tilt" %?&gt;% foobar()</span>
<span class="co">#&gt;  2. ├─global::foobar(.)</span>
<span class="co">#&gt;  3. │ └─x %?&gt;% quux()</span>
<span class="co">#&gt;  4. └─global::quux(.)</span>
<span class="co">#&gt;  5.   └─x %?&gt;% stop()</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="tidyverse">
  <p>magrittr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="https://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by Stefan Milton Bache, <a href="http://hadley.nz">Hadley Wickham</a>, Lionel Henry, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
